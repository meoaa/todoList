<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Todo list</title>
</head>
<body>
    <h1>todo list</h1>

    <div th:if="${#lists.isEmpty(todos)}" id="not_todo">
        <h2>할 일이 존재하지 않습니다.</h2>
    </div>
    <div id="list_box">
        <div th:if="${!#lists.isEmpty(todos)}">
            <ul id="todo_list">
                <li th:each="todo : ${todos}">
                    <span th:text="${todo.title}">할 일</span>
                    <span th:text="${todo.completedText}">완료여부</span>
                    <span th:text="${todo.getFormattedCreatedAt}">등록 시간</span>
                    <button
                        type="button"
                        class="delete-btn"
                        th:attr="data-id=${todo.id}">삭제</button>
                </li>
            </ul>
        </div>
    </div>

    <div>
        <span>할 일 추가</span><label>
        <input type="text" name="title" id="title"/>
        <button id="button" type="button">등록</button>
    </div>
</body>
<script>
    const todoBtn = document.querySelector("#button");
    const title = document.querySelector("#title");
    const deleteBtns = document.querySelectorAll(".delete-btn");
    const notTodo = document.querySelector("#not_todo");
    deleteBtns.forEach(btn => {
        btn.addEventListener("click", function(event){
            deleteTodo(event)
        });
    })

    todoBtn.addEventListener("click",()=>{
        const payload = { title : title.value };
        fetch('/api/todo', {
            method: 'POST',
            headers: {
                'Content-Type' : 'application/json',
                'Accept' : 'application/json'
            },
            body: JSON.stringify(payload)
        })
        .then(res => {
            if(!res.ok){
                throw new Error("HTTP ERROR");
            }
            return res.json();
        })
        .then(data => {

        let ulTag = document.querySelector("#todo_list")

        console.log(data);

        if(ulTag == null){

            notTodo.style.display = "none";

            const listBox = document.querySelector("#list_box");
            const divTag = document.createElement("div")

            ulTag = document.createElement("ul");
            ulTag.id = "todo_list";
            divTag.appendChild(ulTag);
            listBox.appendChild(divTag);

        }

        const liTag = document.createElement("li");
        const spanTitleTag = document.createElement("span");
        const spanCompletedTag = document.createElement("span");
        const spanDateTag = document.createElement("span");
        const deleteBtn = document.createElement("button");
        deleteBtn.type = "button";
        deleteBtn.dataset.id = data.id;
        deleteBtn.className = "delete-btn";
        deleteBtn.innerText = "삭제";
        deleteBtn.addEventListener("click", function(event){
            deleteTodo(event)
        })

        spanTitleTag.innerText = data.title;
        spanCompletedTag.innerText = data.completedText;
        spanDateTag.innerText = data.formattedCreatedAt;


        liTag.appendChild(spanTitleTag);
        liTag.appendChild(spanCompletedTag);
        liTag.appendChild(spanDateTag);
        liTag.appendChild(deleteBtn);
        ulTag.appendChild(liTag);
        })
    });

    function deleteTodo(event){
        const id = event.target.dataset.id;
        const li = event.target.closest("li");
        if(confirm("삭제하시겠습니까?")){
            fetch(`/api/todo/${id}`,{
            method: "DELETE"
            })
            .then(res=>{
            console.log(res);
            li.remove();
            if(deleteBtns.length == 0){
                notTodo.style.display = "block";
            }
            })
        }

    }
</script>
</html>